
#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#define PI       3.141592654




void PrintFrame(FILE *fp, double LHA, int c)

{ int    i,j,d,lha;
  double y;

  lha=(int)LHA;

  fprintf(fp,"gsave 0.7 setlinewidth\n");

  for(j=0; j<2; j++)
  { fprintf(fp," 0 %.1f  moveto 486.0 0 rlineto 0 -340.0 rlineto -486.0 0 rlineto closepath stroke\n",732.0-356.0*j);
  
    for(i=0; i<5; i++)
    { fprintf(fp," %.1f %.1f moveto 92.0 0 rlineto 0 -18.0 rlineto -92.0 0 rlineto closepath  stroke\n",26.0+i*92.0,732.0-356.0*j);
      fprintf(fp," %.1f %.1f moveto 92.0 0 rlineto 0 -322.0 rlineto -92.0 0 rlineto closepath  stroke\n",26.0+i*92.0,714.0-356.0*j);
      fprintf(fp," %.1f %.1f moveto 10 f1 (LHA  %d\\260, %d\\260) show\n",32.0+i*92.0,718.0-356.0*j,lha+i+j*5,360-lha-(i+j*5));
      fprintf(fp," %.1f %.1f moveto  8 f4 ( H ) show\n",26.0+i*92.0,700.0-356.0*j);
      fprintf(fp," %.1f %.1f moveto  8 f4 (\\260  ') show\n",38.0+i*92.0,700.0-356.0*j);
      fprintf(fp," %.1f %.1f moveto  6 f4 (dH ') show\n",67.0+i*92.0,700.0-356.0*j);
      fprintf(fp," %.1f %.1f moveto  8 f4 ( Z  \\260) show\n",84.0+i*92.0,700.0-356.0*j);
    }

    fprintf(fp,"2.0 %.1f moveto 10 f1 (Dec) show\n",718.0-356.0*j);

    y=690.0-j*356.0;
    for(d=0; d<30; d++)
    { 
/*    if(c==1) fprintf(fp," 2.4 %.1f moveto 8 f5 (-) show\n",y,d);  */

      if(d<10) fprintf(fp," 8.5 %.1f moveto 8 f5 ( %d\\260) show\n",y,d);
        else   fprintf(fp," 4.0 %.1f moveto 8 f5 ( %d\\260) show\n",y,d);

      if((d%5)==4) y-=16.8; else y-=8.4;
    }
  }

  fprintf(fp,"6 f0\n  0 17.6 moveto\n(Warning:) show\n");
  fprintf(fp,"6 f0\n 30 17.6 moveto\n(This page has been generated by a computer program. Complex computer programs usually have bugs and may produce wrong data.) show\n");
  fprintf(fp,"6 f0\n 30  8.8 moveto\n(The data on this page is believed to be accurate but no warranty is given for it's correctness. Use it only for training and exercising! ) show\n");
  fprintf(fp,"grestore\n");

  return;
} 






void PrintHeader(FILE *fp, int lat, char *Titl)

{
  fprintf(fp,"%%!PS-Adobe-3.0\n");
  fprintf(fp,"%%%%BeginProlog\n");
  fprintf(fp,"%%%%DocumentData: Clean7Bit\n");
  fprintf(fp,"%%%%Orientation: Portrait\n");
  fprintf(fp,"[ /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef\n");
  fprintf(fp," /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef\n");
  fprintf(fp," /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef\n");
  fprintf(fp," /.notdef /.notdef /space /exclam /quotedbl /numbersign /dollar /percent /ampersand /quoteright\n");
  fprintf(fp," /parenleft /parenright /asterisk /plus /comma /hyphen /period /slash /zero /one\n");
  fprintf(fp," /two /three /four /five /six /seven /eight /nine /colon /semicolon\n");
  fprintf(fp," /less /equal /greater /question /at\n");
  fprintf(fp," /A /B /C /D /E /F /G /H /I /J /K /L /M /N /O /P /Q /R /S /T /U /V /W /X /Y /Z\n");
  fprintf(fp," /bracketleft /backslash /bracketright /asciicircum /underscore /quoteleft\n");
  fprintf(fp," /a /b /c /d /e /f /g /h /i /j /k /l /m /n /o /p /q /r /s /t /u /v /w /x /y /z\n");
  fprintf(fp," /braceleft /bar /braceright /asciitilde /.notdef /.notdef /.notdef\n");
  fprintf(fp," /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef\n");
  fprintf(fp," /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef\n");
  fprintf(fp," /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef /.notdef\n");
  fprintf(fp," /space /exclamdown /cent /sterling /currency /yen /brokenbar /section /dieresis /copyright\n");
  fprintf(fp," /ordfeminine /guillemotleft /logicalnot /hyphen /registered /macron /degree /plusminus\n");
  fprintf(fp," /twosuperior /threesuperior /acute /mu /paragraph /periodcentered /cedilla /onesuperior\n");
  fprintf(fp," /ordmasculine /guillemotright /onequarter /onehalf\n");
  fprintf(fp," /threequarters /questiondown /Agrave /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla\n");
  fprintf(fp," /Egrave /Eacute /Ecircumflex /Edieresis /Igrave /Iacute /Icircumflex /Idieresis /Eth /Ntilde\n");
  fprintf(fp," /Ograve /Oacute /Ocircumflex /Otilde /Odieresis /multiply /Oslash /Ugrave /Uacute /Ucircumflex\n");
  fprintf(fp," /Udieresis /Yacute /Thorn /germandbls /agrave /aacute /acircumflex /atilde /adieresis /aring\n");
  fprintf(fp," /ae /ccedilla /egrave /eacute /ecircumflex /edieresis /igrave /iacute /icircumflex /idieresis\n");
  fprintf(fp," /eth /ntilde /ograve /oacute /ocircumflex /otilde /odieresis /divide /oslash /ugrave\n");
  fprintf(fp," /uacute /ucircumflex /udieresis /yacute /thorn /ydieresis] /isolatin1encoding exch def\n");
  fprintf(fp,"/F0\n");
  fprintf(fp,"    /Helvetica findfont\n");
  fprintf(fp,"    dup length dict begin\n");
  fprintf(fp,"	{1 index /FID ne {def} {pop pop} ifelse} forall\n");
  fprintf(fp,"	/Encoding isolatin1encoding def\n");
  fprintf(fp,"    currentdict end\n");
  fprintf(fp,"definefont pop\n");
  fprintf(fp,"/f0 { /F0 findfont exch scalefont setfont } bind def\n");
  fprintf(fp,"/F1\n");
  fprintf(fp,"    /Helvetica-Bold findfont\n");
  fprintf(fp,"    dup length dict begin\n");
  fprintf(fp,"	{1 index /FID ne {def} {pop pop} ifelse} forall\n");
  fprintf(fp,"	/Encoding isolatin1encoding def\n");
  fprintf(fp,"    currentdict end\n");
  fprintf(fp,"definefont pop\n");
  fprintf(fp,"/f1 { /F1 findfont exch scalefont setfont } bind def\n");
  fprintf(fp,"/F2\n");
  fprintf(fp,"    /Helvetica-Italic findfont\n");
  fprintf(fp,"    dup length dict begin\n");
  fprintf(fp,"	{1 index /FID ne {def} {pop pop} ifelse} forall\n");
  fprintf(fp,"	/Encoding isolatin1encoding def\n");
  fprintf(fp,"    currentdict end\n");
  fprintf(fp,"definefont pop\n");
  fprintf(fp,"/f2 { /F2 findfont exch scalefont setfont } bind def\n");
  fprintf(fp,"/F3\n");
  fprintf(fp,"    /Helvetica-BoldItalic findfont\n");
  fprintf(fp,"    dup length dict begin\n");
  fprintf(fp,"	{1 index /FID ne {def} {pop pop} ifelse} forall\n");
  fprintf(fp,"	/Encoding isolatin1encoding def\n");
  fprintf(fp,"    currentdict end\n");
  fprintf(fp,"definefont pop\n");
  fprintf(fp,"/f3 { /F3 findfont exch scalefont setfont } bind def\n");
  fprintf(fp,"/F4\n");
  fprintf(fp,"    /Courier findfont\n");
  fprintf(fp,"    dup length dict begin\n");
  fprintf(fp,"	{1 index /FID ne {def} {pop pop} ifelse} forall\n");
  fprintf(fp,"	/Encoding isolatin1encoding def\n");
  fprintf(fp,"    currentdict end\n");
  fprintf(fp,"definefont pop\n");
  fprintf(fp,"/f4 { /F4 findfont exch scalefont setfont } bind def\n");
  fprintf(fp,"/F5\n");
  fprintf(fp,"    /Courier-Bold findfont\n");
  fprintf(fp,"    dup length dict begin\n");
  fprintf(fp,"	{1 index /FID ne {def} {pop pop} ifelse} forall\n");
  fprintf(fp,"	/Encoding isolatin1encoding def\n");
  fprintf(fp,"    currentdict end\n");
  fprintf(fp,"definefont pop\n");
  fprintf(fp,"/f5 { /F5 findfont exch scalefont setfont } bind def\n");
  fprintf(fp,"/F6\n");
  fprintf(fp,"    /Courier-Oblique findfont\n");
  fprintf(fp,"    dup length dict begin\n");
  fprintf(fp,"	{1 index /FID ne {def} {pop pop} ifelse} forall\n");
  fprintf(fp,"	/Encoding isolatin1encoding def\n");
  fprintf(fp,"    currentdict end\n");
  fprintf(fp,"definefont pop\n");
  fprintf(fp,"/f6 { /F6 findfont exch scalefont setfont } bind def\n");
  fprintf(fp,"/F7\n");
  fprintf(fp,"    /Courier-BoldOblique findfont\n");
  fprintf(fp,"    dup length dict begin\n");
  fprintf(fp,"	{1 index /FID ne {def} {pop pop} ifelse} forall\n");
  fprintf(fp,"	/Encoding isolatin1encoding def\n");
  fprintf(fp,"    currentdict end\n");
  fprintf(fp,"definefont pop\n");
  fprintf(fp,"/f7 { /F7 findfont exch scalefont setfont } bind def\n");
  fprintf(fp,"/Cshow { dup stringwidth pop -2 div 0 rmoveto show } def\n");
  fprintf(fp,"/Rshow { dup stringwidth pop neg 0 rmoveto show } def\n");
  fprintf(fp,"%%%%EndProlog\n");
  fprintf(fp,"%%%%Page: 1 1\n");
  fprintf(fp,"%%%%BeginPageSetup\n");
  fprintf(fp,"54 72 translate\n");
  fprintf(fp,"%%%%EndPageSetup\n");
  fprintf(fp,"newpath 0 0 moveto 500 0 rlineto 0 700 rlineto -500 0 rlineto  closepath clip newpath\n");
  fprintf(fp,"0.5 setgray\n1.0 setlinewidth\n");
  fprintf(fp,"-40 685 moveto 24 f0 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 655 moveto 36 f3 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-100 630 moveto 24 f7 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 590 moveto 48 f2 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-200 555 moveto 36 f6 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 530 moveto 24 f0 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-10 490 moveto 48 f4 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 465 moveto 24 f3 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 435 moveto 36 f5 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-80 410 moveto 24 f0 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 370 moveto 48 f0 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 335 moveto 36 f4 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 310 moveto 24 f3 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-10 285 moveto 24 f7 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 255 moveto 36 f0 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-90 230 moveto 24 f5 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 210 moveto 24 f4 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 170 moveto 48 f1 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 140 moveto 24 f0 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40 110 moveto 36 f6 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40  85 moveto 24 f2 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-80  45 moveto 48 f3 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-10  25 moveto 24 f4 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"-40   0 moveto 36 f5 ( Sight Reduction  Sight Reduction  Sight Reduction  Sight Reduction) show\n");
  fprintf(fp,"gsave\n");
  fprintf(fp,"1.0 setgray\n");
  fprintf(fp,"1.0 0.3 scale\n");
  fprintf(fp,"newpath 250 690 228 0 360 arc fill\n");
  fprintf(fp,"0.0 setgray\n2.0 setlinewidth\n");
  fprintf(fp,"newpath 250 690 220 0 360 arc stroke\n");
  fprintf(fp,"grestore\n");
  fprintf(fp,"0.0 setgray\n");
  fprintf(fp,"250 214 moveto 32 f0 (Latitude  %2d\\260 - %2d\\260 ) Cshow\n",lat,lat+4);
  fprintf(fp,"250 184 moveto 16 f0 (%s) Cshow\n",Titl);
  fprintf(fp,"showpage\n");
  fprintf(fp,"%%%%EOF\n");

  return;
}



void InsertBlankPage(FILE *fp, int *page)

{
  fprintf(fp,"%%%%Page: %d %d\n",*page,*page);
  fprintf(fp,"gsave 0.9 setgray\n");
  fprintf(fp,"36 f0\n");
  fprintf(fp,"300 400 moveto (Blank Page) Cshow\n");
  fprintf(fp,"grestore\n");
  fprintf(fp,"showpage\n");

  *page = (*page)+1;

  return;
}






int main(int argc, char **argv)

{ int    i,j,k,h,n,cont;
  int    lat,dec;
  int    font,page;
  char   nam,sgn,Titl[64];

  double r,s,y,m;
  double Dec,Lat,LHA,Zc[31],Hc[31],dH;

  double sinDec,cosDec;
  double sinLHA,cosLHA;
  double sinLat,cosLat;

  char   filename[32];
  FILE  *fp;

  r=PI/180.0;
  s=180.0/PI;


  if(argc!=2) 
  { printf(" Usage: %s <Latitude>\n\n",argv[0]);
    exit(0);
  }

  lat=atoi(argv[1]);
  if((lat<0)||(lat>90))
  { printf(" Error (%s) Latitude out of range [0:90]: %d\n\n",argv[0],lat);
    exit(-1);
  }

  lat=5*(int)(lat/5);

  printf("\n Generating Sight Reduction Tables for : Latitude  %2d\260 - %2d\260\n\n",lat,lat+4);
  

  for(n=0; n<2; n++)                                               /* n=0: SAME;    n=1: CONTRARY                        */
  {
    if(n==0) { strcpy(Titl,"Declination SAME name as Latitude"); nam='s'; } 
      else   { strcpy(Titl,"Declination CONTRARY name to Latitude"); nam='c'; }

    if(lat<10) sprintf(filename,"Data/SiRed0%d%c.ps",lat,nam);
      else     sprintf(filename,"Data/SiRed%d%c.ps",lat,nam);
  
    if((fp=fopen(filename,"w"))==NULL)
    { printf(" Error (%s) could not open file \"%s\" for reading!\n",argv[0],filename);
      exit(-1);
    }
  
    printf("                     writing data file : \"%s\"\n",filename);

    PrintHeader(fp,lat,Titl);

    page=2;
    for(Lat=(double)lat; Lat< (double)(lat+5.00); Lat=Lat+1.00)
    {
      sinLat=sin(r*Lat);
      cosLat=cos(r*Lat);

      if(!(page%2)) InsertBlankPage(fp,&page);
      
      for(LHA=0.0; LHA<180.0; LHA+=10.0)
      { fprintf(fp,"%%%%Page: %d %d\n%%%%BeginPageSetup\n40 30 translate\n%%%%EndPageSetup\n",page,page);
 
        if(page%2)
        { fprintf(fp,"24 0 translate\n");
          fprintf(fp,"485 748.0 moveto 14 f1 (Latitude %2d\\260) Rshow\n",(int)Lat);
          fprintf(fp,"0 748.0 moveto 12 f1 (%s) show\n",Titl);
        }
          else
          { fprintf(fp,"0 748.0 moveto 14 f1 (Latitude %2d\\260) show\n",(int)Lat);
            fprintf(fp,"485 748.0 moveto 12 f1 (%s) Rshow\n",Titl);
          }
              
        PrintFrame(fp,LHA,n);
  
        cont=1;

        for(j=0; j<2; j++)
          for(k=0; k<5; k++)
          { sinLHA=sin(r*(LHA+k+j*5.0));     
            cosLHA=cos(r*(LHA+k+j*5.0));     
          
            for(dec=0; dec<31; dec++)
            { if(n==0) Dec=(double)dec; else Dec=(double)-dec;

              sinDec=sin(r*Dec);
              cosDec=cos(r*Dec);
              Hc[dec]=s*asin(sinLat*sinDec + cosLat*cosDec*cosLHA);
              Hc[dec]=floor(Hc[dec]*600+0.5);
              Zc[dec]=s*atan2(cosDec*sinLHA,cosLat*sinDec - sinLat*cosDec*cosLHA);
            }     
          
            y=690.0-j*356.0;
            for(dec=0; dec<30; dec++)
            { dH=(Hc[dec+1]-Hc[dec])/10.0;
              if(dH<0.0) { sgn='-'; dH=fabs(dH); }
                else     { sgn='+';              }

              if(Hc[dec]>=0.0) font=4; else font=6;

              if((Hc[dec]>=0.0)&&(cont==1))
              { h=floor(Hc[dec]/600.0);
                m=(Hc[dec]-h*600.0)/10.0;
                if(m<0.0) m*=-1.0;

                fprintf(fp," %.1f %.1f moveto 8 f%d ( %2d) show\n",26.0+92.0*k,y,font,h); 
                if(m<10.0) fprintf(fp," %.1f %.1f moveto 8 f%d ( 0%3.1f) show\n",38.0+92.0*k,y,font,m);
                  else     fprintf(fp," %.1f %.1f moveto 8 f%d ( %4.1f) show\n",38.0+92.0*k,y,font,m);

                if(dH<10.0) fprintf(fp," %.1f %.1f moveto 6 f%d (%c0%3.1f) show\n",66.0+92.0*k,y,font,sgn,dH);
                  else     fprintf(fp," %.1f %.1f moveto 6 f%d (%c%4.1f) show\n",66.0+92.0*k,y,font,sgn,dH);
                
                fprintf(fp," %.1f %.1f moveto 8 f%d ( %5.1f) show\n",84.0+92.0*k,y,font,Zc[dec]);
              }

              if((Hc[dec]< 0.0)&&(cont==1))
              { h=floor(-Hc[dec]/600.0);
                m=(-Hc[dec]-h*600.0)/10.0;
                if(m<0.0) m*=-1.0;

                if(h<10)
                { fprintf(fp," %.1f %.1f moveto 8 f%d ( -%1d) show\n",26.0+92.0*k,y,font,h);
                  if(m<10.0) fprintf(fp," %.1f %.1f moveto 8 f%d ( 0%3.1f) show\n",38.0+92.0*k,y,font,m);
                    else     fprintf(fp," %.1f %.1f moveto 8 f%d ( %4.1f) show\n",38.0+92.0*k,y,font,m);
 
                  if(dH<10.0) fprintf(fp," %.1f %.1f moveto 6 f%d (%c0%3.1f) show\n",66.0+92.0*k,y,font,sgn,dH);
                    else     fprintf(fp," %.1f %.1f moveto 6 f%d (%c%4.1f) show\n",66.0+92.0*k,y,font,sgn,dH);
                }
              }
              
              if((dec%5)==4) y-=16.8; else y-=8.4;
            }    
            if((Hc[0]<0.0)&&(Hc[29]<0.0)) cont=0;
          }

        fprintf(fp,"showpage\n");
        page++;

        if(cont==0) LHA=181.0;
      }
    }

    fprintf(fp,"%%EOF\n");
    fclose(fp);
  }
  
  printf("\n");
  return 0;
}
